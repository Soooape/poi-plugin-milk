{"version":3,"sources":["fleet-list.es"],"names":["i18n","window","__","bind","FleetList","constructor","props","componentDidMount","addEventListener","handleResponse","componentWillUnmount","removeEventListener","e","path","postBody","detail","timeElapsed","lastRefresh","state","setState","Date","now","fleetId","parseInt","api_id","shipId","api_ship_id","Number","isNaN","fleet","infleet","filter","id","api_highspeed","tick","resetTimeElapsed","render","canRepair","akashiFlagship","inExpedition","flagShipInRepair","repairCount","map","repairDetail","ship","propTypes","object","isRequired"],"mappings":"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","file":"fleet-list.es","sourcesContent":["import React, { Component } from 'react'\nimport PropTypes from 'prop-types'\nimport _ from 'lodash'\nimport { Table, Grid, Row, Col, OverlayTrigger, Tooltip, Label, Panel } from 'react-bootstrap'\n\nimport CountupTimer from './countup-timer'\nimport { AKASHI_INTERVAL } from './functions'\n\nimport ShipRow from './ship-row'\n\nconst { i18n } = window\nconst __ = i18n['poi-plugin-anchorage-repair'].__.bind(i18n['poi-plugin-anchorage-repair'])\n\n\nexport default class FleetList extends Component {\n  static propTypes = {\n    fleet: PropTypes.object.isRequired,\n  }\n\n  constructor(props) {\n    super(props)\n\n    this.state = {\n      lastRefresh: 0,\n      timeElapsed: 0,\n    }\n  }\n\n\n  componentDidMount= () => {\n    window.addEventListener('game.response', this.handleResponse)\n  }\n\n  componentWillUnmount = () => {\n    window.removeEventListener('game.response', this.handleResponse)\n  }\n\n\n  handleResponse = (e) => {\n    const { path, postBody } = e.detail\n    const { timeElapsed, lastRefresh } = this.state\n    switch (path) {\n      case '/kcsapi/api_port/port':\n        if (timeElapsed >= (AKASHI_INTERVAL / 1000) || lastRefresh === 0) {\n          this.setState({\n            lastRefresh: Date.now(),\n            timeElapsed: 0,\n          })\n        }\n        break\n\n      case '/kcsapi/api_req_hensei/change': {\n        const fleetId = parseInt(postBody.api_id, 10)\n        const shipId = parseInt(postBody.api_ship_id, 10)\n        // const shipIndex = parseInt(postBody.api_ship_idx)\n        if (!Number.isNaN(fleetId)\n        && fleetId === this.props.fleet.api_id\n        && shipId >= 0) {\n          if (timeElapsed < (AKASHI_INTERVAL / 1000)) {\n            this.setState({\n              lastRefresh: Date.now(),\n              timeElapsed: 0,\n            })\n          } else if (shipId < 0) {\n          // do nothing\n          } else {\n            this.setState({ // since it has passed more than 20 minutes, need to refresh the hp\n              lastRefresh: 0,\n            })\n          }\n        }\n        break\n      }\n      case '/kcsapi/api_req_nyukyo/start': {\n        const shipId = parseInt(postBody.api_ship_id, 10)\n        const infleet = _.filter(this.props.fleet.shipId, id => shipId === id)\n        if (postBody.api_highspeed === 1 && infleet != null) {\n          this.setState({ lastRefresh: Date.now() })\n        }\n        break\n      }\n      default:\n    }\n  }\n\n  tick = (timeElapsed) => {\n    if (timeElapsed % 5 === 0) { // limit component refresh rate\n      this.setState({ timeElapsed })\n    }\n  }\n\n  resetTimeElapsed = () => {\n    this.setState({ timeElapsed: 0 })\n  }\n\n  render() {\n    const { timeElapsed, lastRefresh } = this.state\n    const { fleet } = this.props\n\n    return (\n      <Grid>\n        <Row className=\"info-row\">\n          <Col xs={4} className=\"info-col\">\n            <OverlayTrigger\n              placement=\"bottom\"\n              trigger={fleet.canRepair ? 'click' : ['hover', 'focus']}\n              overlay={\n                <Tooltip id={`anchorage-refresh-notify-${fleet.api_id}`}>\n                  <p>{fleet.canRepair ? __('Akashi loves you!') : '' }</p>\n                  <p>{fleet.akashiFlagship ? '' : __('Akashi not flagship')}</p>\n                  <p>{fleet.inExpedition ? __('fleet in expedition') : ''}</p>\n                  <p>{fleet.flagShipInRepair ? __('flagship in dock') : ''}</p>\n                </Tooltip>\n            }\n            >\n              <Label bsStyle={fleet.canRepair ? 'success' : 'warning'}>\n                {fleet.canRepair ? __('Repairing') : __('Not ready')}\n              </Label>\n            </OverlayTrigger>\n          </Col>\n          <Col xs={4} className=\"info-col\">\n            {\n              <Label bsStyle={fleet.canRepair ? 'success' : 'warning'}>\n                <span>{__('Elapsed:')} </span>\n                <CountupTimer\n                  countdownId={`akashi-${fleet.api_id}`}\n                  startTime={this.state.lastRefresh}\n                  tickCallback={this.tick}\n                  startCallback={this.resetTimeElapsed}\n                />\n              </Label>\n\n          }\n          </Col>\n          <Col xs={4} className=\"info-col\">\n            <Label bsStyle={fleet.repairCount ? 'success' : 'warning'}>{__('Capacity: %s', fleet.repairCount)}</Label>\n          </Col>\n        </Row>\n        <Row>\n          <Col xs={12}>\n            <Panel bsStyle=\"warning\" className={lastRefresh === 0 ? '' : 'hidden'}>\n              {__('Please return to HQ screen to make timer refreshed.')}\n            </Panel>\n          </Col>\n        </Row>\n        <Row>\n          <Col xs={12}>\n            <Table bordered condensed>\n              <thead>\n                <tr>\n                  <th>{__('Ship')}</th>\n                  <th>{__('HP')}</th>\n                  <th>\n                    <OverlayTrigger\n                      placement=\"top\"\n                      overlay={\n                        <Tooltip id={'akashi-time-desc'}>\n                          {__('Total time required')}\n                        </Tooltip>\n                    }\n                    >\n                      <span>{__('Akashi Time')}</span>\n                    </OverlayTrigger >\n                  </th>\n                  <th>\n                    <OverlayTrigger\n                      placement=\"top\"\n                      overlay={\n                        <Tooltip id={'akashi-time-desc'}>\n                          {__('Time required for 1 HP recovery')}\n                        </Tooltip>\n                    }\n                    >\n                      <span>{__('Per HP')}</span>\n                    </OverlayTrigger >\n                  </th>\n                  <th>\n                    <OverlayTrigger\n                      placement=\"top\"\n                      overlay={\n                        <Tooltip id={'akashi-time-desc'}>\n                          {__('Estimated HP recovery since last refresh')}\n                        </Tooltip>\n                      }\n                    >\n                      <span>{__('Estimated repaired')}</span>\n                    </OverlayTrigger >\n                  </th>\n                </tr>\n              </thead>\n              <tbody>\n                {\n                  _.map(fleet.repairDetail, ship => (\n                    <ShipRow\n                      key={`anchorage-ship-${ship.api_id}`}\n                      ship={ship}\n                      lastRefresh={lastRefresh}\n                      timeElapsed={timeElapsed}\n                      canRepair={fleet.canRepair}\n                    />))\n                }\n              </tbody>\n            </Table>\n          </Col>\n        </Row>\n      </Grid>\n    )\n  }\n}\n"]}
