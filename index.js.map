{"version":3,"sources":["index.es"],"names":["i18n","getStore","window","__","bind","AKASHI_ID","SRF_ID","fleetAkashiConv","fleet","$ships","ships","equips","repairId","pickKey","canRepair","akashiFlagship","repairCount","inExpedition","get","flagShipInRepair","includes","flagship","api_ship_id","filter","api_slot","item","length","repairDetail","map","api_ship","shipId","index","ship","pick","constShip","estimate","timePerHP","api_lv","api_stype","inRepair","api_id","availableSRF","repairIdSelector","repair","dock","constShipsSelector","state","const","fleetsAkashiSelector","fleets","reactClass","data","canNotify","PluginAnchorageRepair","constructor","props","handleSelectTab","key","setState","activeTab","handleSort","sortIndex","render","__dirname","expedReturnLock","clearExpedReturnLock","clearTimeout","switchPluginPath","path","valid","repairs","result","some","setTimeout"],"mappings":"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","file":"index.es","sourcesContent":["import React, { Component } from 'react'\nimport { connect } from 'react-redux'\nimport { createSelector } from 'reselect'\nimport _ from 'lodash'\nimport { join } from 'path'\nimport { Tabs, Tab } from 'react-bootstrap'\n\n// Import selectors defined in poi\nimport {\n  fleetsSelector,\n  shipsSelector,\n  equipsSelector,\n  repairsSelector,\n  miscSelector,\n  createDeepCompareArraySelector,\n} from 'views/utils/selectors'\n\nimport {\n  akashiEstimate,\n  getTimePerHP,\n} from './parts/functions'\nimport FleetList from './parts/fleet-list'\nimport Candidates from './parts/candidates'\n\nconst { i18n, getStore } = window\nconst __ = i18n['poi-plugin-anchorage-repair'].__.bind(i18n['poi-plugin-anchorage-repair'])\n\nconst AKASHI_ID = [182, 187] // akashi and kai ID in $ships\nconst SRF_ID = 86 // Ship Repair Facility ID in $slotitems\n\n\n// check a fleet status, returns information related to anchorage repair\nconst fleetAkashiConv = (fleet, $ships, ships, equips, repairId) => {\n  const pickKey = ['api_id', 'api_ship_id', 'api_lv', 'api_nowhp', 'api_maxhp', 'api_ndock_time']\n\n  let canRepair = false\n  let akashiFlagship = false\n  let repairCount = 0\n  const inExpedition = _.get(fleet, 'api_mission.0') && true\n  const flagShipInRepair = _.includes(repairId, _.get(fleet, 'api_ship.0', -1))\n  const flagship = ships[_.get(fleet, 'api_ship.0', -1)]\n\n  if (flagship != null) {\n    akashiFlagship = _.includes(AKASHI_ID, flagship.api_ship_id)\n    repairCount = _.filter(flagship.api_slot, item => _.get(equips, `${item}.api_slotitem_id`, -1) === SRF_ID).length\n    repairCount += akashiFlagship ? 2 : 0\n  }\n\n  canRepair = akashiFlagship && !inExpedition && !flagShipInRepair\n\n  const repairDetail = _.map(_.filter(fleet.api_ship, shipId => shipId > 0), (shipId, index) => {\n    if (shipId === -1) return false // break, LODASH ONLY\n\n    const ship = _.pick(ships[shipId], pickKey)\n\n    const constShip = _.pick($ships[ship.api_ship_id], ['api_name', 'api_stype'])\n\n    return {\n      ...ship,\n      ...constShip,\n      estimate: akashiEstimate(ship),\n      timePerHP: getTimePerHP(ship.api_lv, constShip.api_stype),\n      inRepair: _.includes(repairId, ship.api_id),\n      availableSRF: index < repairCount,\n    }\n  })\n\n  return {\n    api_id: fleet.api_id || -1,\n    shipId: fleet.api_ship || [],\n    canRepair,\n    akashiFlagship,\n    inExpedition,\n    flagShipInRepair,\n    repairCount,\n    repairDetail,\n  }\n}\n\n// selectors\n\nconst repairIdSelector = createSelector(\n  [repairsSelector],\n  repair => _.map(repair, dock => dock.api_ship_id)\n)\n\nconst constShipsSelector = state => state.const.$ships || {}\n\nconst fleetsAkashiSelector = createSelector(\n  [\n    constShipsSelector,\n    fleetsSelector,\n    shipsSelector,\n    equipsSelector,\n    repairIdSelector,\n  ],\n  ($ships, fleets, ships, equips, repairId) =>\n    ({ fleets: _.map(fleets, fleet => fleetAkashiConv(fleet, $ships, ships, equips, repairId)) })\n\n)\n\n\n// React\n\nexport const reactClass = connect(\n  createDeepCompareArraySelector([\n    fleetsAkashiSelector,\n    miscSelector,\n  ], (data, { canNotify }) => ({\n    ...data,\n    canNotify,\n  }))\n)(class PluginAnchorageRepair extends Component {\n\n  constructor(props) {\n    super(props)\n\n    this.state = {\n      activeTab: 1,\n      sortIndex: 0,\n    }\n  }\n\n  handleSelectTab = (key) => {\n    this.setState({ activeTab: key })\n  }\n\n  handleSort = index => () => {\n    this.setState({\n      sortIndex: index,\n    })\n  }\n\n  render() {\n    return (\n      <div id=\"anchorage-repair\">\n        <link rel=\"stylesheet\" href={join(__dirname, 'assets', 'style.css')} />\n        <Tabs activeKey={this.state.activeTab} onSelect={this.handleSelectTab} id=\"anchorage-tabs\">\n          {\n            _.map(this.props.fleets, (fleet, index) => (\n              <Tab\n                eventKey={fleet.api_id}\n                title={fleet.api_id}\n                key={`anchorage-tab-${index}`}\n                tabClassName={fleet.canRepair ? 'can-repair' : ''}\n              >\n                <FleetList fleet={fleet} />\n              </Tab>\n            ))\n          }\n          <Tab\n            className=\"candidate-pane\"\n            eventKey={-1}\n            title={__('Candidates')}\n          >\n            <Candidates handleSort={this.handleSort} sortIndex={this.state.sortIndex} />\n          </Tab>\n        </Tabs>\n      </div>\n    )\n  }\n})\n\n\n/*\n\n   The following APIs are called in order when a fleet returns from expedition:\n\n   - api_req_mission/result\n   - api_port/port\n\n   As anchorage repair pops up conditionally on the latter one,\n   it also prevents other plugins' auto-switch mechanism on\n   tracking api_req_mission/result calls.\n\n   The problem is solved by applying a lock upon expedition returns\n   and ignoring the immediately followed api_port/port call.\n\n */\nlet expedReturnLock = null\nconst clearExpedReturnLock = () => {\n  if (expedReturnLock !== null) {\n    clearTimeout(expedReturnLock)\n    expedReturnLock = null\n  }\n}\n\nexport const switchPluginPath = [\n  {\n    path: '/kcsapi/api_port/port',\n    valid: () => {\n      if (expedReturnLock !== null) {\n        /*\n           this is the immediately followed api_port/port call\n           after an expedition returning event.\n         */\n        clearExpedReturnLock()\n        return false\n      }\n\n      const { fleets = [], ships = {}, equips = {}, repairs = [] } = getStore('info') || {}\n      const $ships = getStore('const.$ships')\n      const repairId = repairs.map(dock => dock.api_ship_id)\n\n      const result = fleets.map(fleet => fleetAkashiConv(fleet, $ships, ships, equips, repairId))\n      return result.some(fleet =>\n        fleet.canRepair && fleet.repairDetail.some(ship => ship.estimate > 0))\n    },\n  },\n  {\n    path: '/kcsapi/api_req_mission/result',\n    valid: () => {\n      clearExpedReturnLock()\n      expedReturnLock = setTimeout(\n        clearExpedReturnLock,\n        /*\n           allow a window of 5 secnds before the lock\n           clears itself\n         */\n        5000\n      )\n      return false\n    },\n  },\n]\n"]}
